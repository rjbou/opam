N0REP0
### <pkg:foo.1>
opam-version: "2.0"
### <pkg:foo.2>
opam-version: "2.0"
### <pkg:bar.1>
opam-version: "2.0"
### <pkg:bar.3>
opam-version: "2.0"
### <pkg:baz.1>
opam-version: "2.0"
### <pkg:qux.1>
opam-version: "2.0"
### <pin:tolock/tolock.opam>
opam-version: "2.0"
depends: [ "foo" "bar" ]
build: [ "test" "-f" "content" ]
### <tolock/content>
it's here
### OPAMYES=1
### : simple lock file :
### opam update

<><> Updating package repositories ><><><><><><><><><><><><><><><><><><><><><><>
[default] synchronised from file://${BASEDIR}/REPO
Now run 'opam upgrade' to apply any package updates.
### opam switch create locking --empty
### opam pin -n ./tolock --with-version 1
Package tolock does not exist, create as a NEW package? [Y/n] y
tolock is now pinned to file://${BASEDIR}/tolock (version 1)
### opam lock tolock
[ERROR] Skipping tolock.1, dependencies are not satisfied in this switch, not installed packages are:
          - foo
          - bar

No lock file generated
### opam install foo.1
The following actions will be performed:
  - install foo 1

<><> Processing actions <><><><><><><><><><><><><><><><><><><><><><><><><><><><>
-> installed foo.1
Done.
### opam lock tolock
[ERROR] Skipping tolock.1, dependencies are not satisfied in this switch, not installed packages are:
          - bar

No lock file generated
### opam install bar.1
The following actions will be performed:
  - install bar 1

<><> Processing actions <><><><><><><><><><><><><><><><><><><><><><><><><><><><>
-> installed bar.1
Done.
### opam lock tolock
Generated lock files for:
  - tolock.1: ${BASEDIR}/tolock.opam.locked
### opam-cat tolock.opam.locked
authors: "the testing team"
bug-reports: "https://nobug"
build: ["test" "-f" "content"]
depends: ["bar" {= "1"} "foo" {= "1"}]
description: "Two words."
dev-repo: "hg+htpps://to@lo.ck"
homepage: "egapemoh"
license: "ISC"
maintainer: "maint@tain.er"
name: "tolock"
opam-version: "2.0"
synopsis: "A word"
version: "1"
url {
src: "file://${BASEDIR}/tolock"
}
### opam lock tolock --lock-suffix new
Generated lock files for:
  - tolock.1: ${BASEDIR}/tolock.opam.new
### opam show --just-file --normalise ./tolock.opam.new --field depends,depopts,conflicts
depends:   ["bar" {= "1"} "foo" {= "1"}]
depopts:
conflicts:
### <pin:tolock/tolock.opam>
opam-version: "2.0"
depends: [ "foo" "bar" ]
depopts: "baz"
build: [ "test" "-f" "content" ]
### opam update tolock

<><> Synchronising development packages <><><><><><><><><><><><><><><><><><><><>
[tolock.1] synchronised (file://${BASEDIR}/tolock)
[tolock] Installing new package description from upstream file://${BASEDIR}/tolock
Now run 'opam upgrade' to apply any package updates.
### opam lock tolock
Generated lock files for:
  - tolock.1: ${BASEDIR}/tolock.opam.locked
### opam show --just-file --normalise ./tolock.opam.locked --field depends,depopts,conflicts
depends:   ["bar" {= "1"} "foo" {= "1"}]
depopts:
conflicts: ["baz"]
### opam install baz.1
The following actions will be performed:
  - install baz 1

<><> Processing actions <><><><><><><><><><><><><><><><><><><><><><><><><><><><>
-> installed baz.1
Done.
### opam lock tolock
Generated lock files for:
  - tolock.1: ${BASEDIR}/tolock.opam.locked
### opam show --just-file --normalise ./tolock.opam.locked --field depends,depopts,conflicts
depends:   ["bar" {= "1"} "baz" {= "1"} "foo" {= "1"}]
depopts:
conflicts:
### : error or formulaes :
### ### ERROR ###
### <pin:tolock/tolock.opam>
opam-version: "2.0"
depends: [ "foo" ("bar" | "qux") ]
depopts: "baz"
build: [ "test" "-f" "content" ]
### opam lock tolock
[ERROR] Skipping tolock.1, dependencies are not satisfied in this switch, not installed packages are:
          - qux

No lock file generated
### opam show --just-file --normalise ./tolock.opam.locked --field depends,depopts,conflicts
depends:   ["bar" {= "1"} "baz" {= "1"} "foo" {= "1"}]
depopts:
conflicts:
### : lock file install from directory :
### mv tolock.opam.locked ./tolock/
### opam switch create locking2 --empty
### opam-cat tolock/tolock.opam.locked
authors: "the testing team"
bug-reports: "https://nobug"
build: ["test" "-f" "content"]
depends: ["bar" {= "1"} "baz" {= "1"} "foo" {= "1"}]
description: "Two words."
dev-repo: "hg+htpps://to@lo.ck"
homepage: "egapemoh"
license: "ISC"
maintainer: "maint@tain.er"
name: "tolock"
opam-version: "2.0"
synopsis: "A word"
version: "1"
url {
src: "file://${BASEDIR}/tolock"
}
### opam pin -n ./tolock --locked
Package tolock does not exist, create as a NEW package? [Y/n] y
tolock is now pinned to file://${BASEDIR}/tolock (version 1)
### opam show --normalise tolock --field depends:,depopts:,conflicts:
depends:   ["bar" {= "1"} "baz" {= "1"} "foo" {= "1"}]
depopts:
conflicts:
### opam unpin -n tolock
Ok, tolock is no longer pinned to file://${BASEDIR}/tolock (version 1)
### opam install ./tolock --show
The following actions would be performed:
  - install bar    3            [required by tolock]
  - install foo    2            [required by tolock]
  - install tolock dev (pinned)
===== 3 to install =====
### opam install ./tolock --locked --show
The following actions would be performed:
  - install foo    1          [required by tolock]
  - install bar    1          [required by tolock]
  - install baz    1          [required by tolock]
  - install tolock 1 (pinned)
===== 4 to install =====
### : git pin with lock file :
### git -C tolock init -q
### git -C tolock config core.autocrlf false
### git -C tolock add content
### git -C tolock commit -qm "init"
### opam switch create locking3 --empty
### opam pin -n ./tolock --locked
Package tolock does not exist, create as a NEW package? [Y/n] y
tolock is now pinned to git+file://${BASEDIR}/tolock#master (version 1)
### opam show --normalise tolock --field depends:,depopts:,conflicts:
depends:   ["bar" {= "1"} "baz" {= "1"} "foo" {= "1"}]
depopts:
conflicts:
### opam unpin -n tolock
Ok, tolock is no longer pinned to git+file://${BASEDIR}/tolock#master (version 1)
### opam install ./tolock --show
The following actions would be performed:
  - install bar    3            [required by tolock]
  - install foo    2            [required by tolock]
  - install tolock dev (pinned)
===== 3 to install =====
### opam install ./tolock --locked --show
The following actions would be performed:
  - install foo    1          [required by tolock]
  - install bar    1          [required by tolock]
  - install baz    1          [required by tolock]
  - install tolock 1 (pinned)
===== 4 to install =====
### opam pin ./tolock -n
Package tolock does not exist, create as a NEW package? [Y/n] y
tolock is now pinned to git+file://${BASEDIR}/tolock#master (version dev)
### opam install ./tolock --show
The following actions would be performed:
  - install bar    3            [required by tolock]
  - install foo    2            [required by tolock]
  - install tolock dev (pinned)
===== 3 to install =====
### opam install ./tolock --locked --show
The following actions would be performed:
  - install foo    1          [required by tolock]
  - install bar    1          [required by tolock]
  - install baz    1          [required by tolock]
  - install tolock 1 (pinned)
===== 4 to install =====
### opam install ./tolock --locked
tolock is now pinned to git+file://${BASEDIR}/tolock#master (version 1)
[NOTE] Ignoring uncommitted changes in ${BASEDIR}/tolock (`--working-dir' not active).
[tolock.1] synchronised (no changes)
The following actions will be performed:
  - install foo    1          [required by tolock]
  - install bar    1          [required by tolock]
  - install baz    1          [required by tolock]
  - install tolock 1 (pinned)
===== 4 to install =====

<><> Processing actions <><><><><><><><><><><><><><><><><><><><><><><><><><><><>
-> installed bar.1
-> installed baz.1
-> installed foo.1
-> retrieved tolock.1  (no changes)
-> installed tolock.1
Done.
### : git pin woth opam file committed :
### git -C tolock add tolock.opam
### git -C tolock commit -qm "opam file"
### opam switch create locking4 --empty
### opam pin -n ./tolock --locked
Package tolock does not exist, create as a NEW package? [Y/n] y
tolock is now pinned to git+file://${BASEDIR}/tolock#master (version 1)
### opam show --normalise tolock --field depends:,depopts:,conflicts:
depends:   ["bar" {= "1"} "baz" {= "1"} "foo" {= "1"}]
depopts:
conflicts:
### opam unpin -n tolock
Ok, tolock is no longer pinned to git+file://${BASEDIR}/tolock#master (version 1)
### opam install ./tolock --show
The following actions would be performed:
  - install bar    3            [required by tolock]
  - install foo    2            [required by tolock]
  - install tolock dev (pinned)
===== 3 to install =====
### opam install ./tolock --locked --show
The following actions would be performed:
  - install foo    1          [required by tolock]
  - install bar    1          [required by tolock]
  - install baz    1          [required by tolock]
  - install tolock 1 (pinned)
===== 4 to install =====
### opam pin ./tolock -n
Package tolock does not exist, create as a NEW package? [Y/n] y
tolock is now pinned to git+file://${BASEDIR}/tolock#master (version dev)
### opam install ./tolock --show
The following actions would be performed:
  - install bar    3            [required by tolock]
  - install foo    2            [required by tolock]
  - install tolock dev (pinned)
===== 3 to install =====
### opam install ./tolock --locked --show
The following actions would be performed:
  - install foo    1          [required by tolock]
  - install bar    1          [required by tolock]
  - install baz    1          [required by tolock]
  - install tolock 1 (pinned)
===== 4 to install =====
### opam install ./tolock --locked
tolock is now pinned to git+file://${BASEDIR}/tolock#master (version 1)
[NOTE] Ignoring uncommitted changes in ${BASEDIR}/tolock (`--working-dir' not active).
[tolock.1] synchronised (no changes)
The following actions will be performed:
  - install foo    1          [required by tolock]
  - install bar    1          [required by tolock]
  - install baz    1          [required by tolock]
  - install tolock 1 (pinned)
===== 4 to install =====

<><> Processing actions <><><><><><><><><><><><><><><><><><><><><><><><><><><><>
-> installed bar.1
-> installed baz.1
-> installed foo.1
-> retrieved tolock.1  (no changes)
-> installed tolock.1
Done.
### : git pin with lock file committed :
### git -C tolock add tolock.opam.locked
### git -C tolock commit -qm "lock"
### opam switch create locking5 --empty
### opam pin -n ./tolock --locked
Package tolock does not exist, create as a NEW package? [Y/n] y
tolock is now pinned to git+file://${BASEDIR}/tolock#master (version 1)
### opam show --normalise tolock --field depends:,depopts:,conflicts:
depends:   ["bar" {= "1"} "baz" {= "1"} "foo" {= "1"}]
depopts:
conflicts:
### opam unpin -n tolock
Ok, tolock is no longer pinned to git+file://${BASEDIR}/tolock#master (version 1)
### opam install ./tolock --show
The following actions would be performed:
  - install bar    3            [required by tolock]
  - install foo    2            [required by tolock]
  - install tolock dev (pinned)
===== 3 to install =====
### opam install ./tolock --locked --show
The following actions would be performed:
  - install foo    1          [required by tolock]
  - install bar    1          [required by tolock]
  - install baz    1          [required by tolock]
  - install tolock 1 (pinned)
===== 4 to install =====
### opam pin ./tolock -n
Package tolock does not exist, create as a NEW package? [Y/n] y
tolock is now pinned to git+file://${BASEDIR}/tolock#master (version dev)
### opam install ./tolock --show
The following actions would be performed:
  - install bar    3            [required by tolock]
  - install foo    2            [required by tolock]
  - install tolock dev (pinned)
===== 3 to install =====
### opam install ./tolock --locked --show
The following actions would be performed:
  - install foo    1          [required by tolock]
  - install bar    1          [required by tolock]
  - install baz    1          [required by tolock]
  - install tolock 1 (pinned)
===== 4 to install =====
### opam install ./tolock --locked
tolock is now pinned to git+file://${BASEDIR}/tolock#master (version 1)
[tolock.1] synchronised (no changes)
The following actions will be performed:
  - install foo    1          [required by tolock]
  - install bar    1          [required by tolock]
  - install baz    1          [required by tolock]
  - install tolock 1 (pinned)
===== 4 to install =====

<><> Processing actions <><><><><><><><><><><><><><><><><><><><><><><><><><><><>
-> installed bar.1
-> installed baz.1
-> installed foo.1
-> retrieved tolock.1  (no changes)
-> installed tolock.1
Done.
### : upgrade with lock :
### opam switch remove locking
Switch locking and all its packages will be wiped. Are you sure? [Y/n] y
### opam switch create locking --empty
### rm -rf tolock
### <pin:tolock/tolock.opam>
build: [ "false" ]
version: "1"
### <pin:tolock/tolock.opam.locked>
version: "l1"
### opam pin scan ./tolock --locked
# Name  # Version  # Url
tolock  1          file://${BASEDIR}/tolock
### opam pin ./tolock --locked
Package tolock does not exist, create as a NEW package? [Y/n] y
tolock is now pinned to file://${BASEDIR}/tolock (version l1)

The following actions will be performed:
  - install tolock l1 (pinned)

<><> Processing actions <><><><><><><><><><><><><><><><><><><><><><><><><><><><>
-> retrieved tolock.l1  (file://${BASEDIR}/tolock)
-> installed tolock.l1
Done.
### <pin:tolock/tolock.opam.locked>
version: "l2"
### opam update tolock

<><> Synchronising development packages <><><><><><><><><><><><><><><><><><><><>
[tolock.l1] synchronised (file://${BASEDIR}/tolock)
Now run 'opam upgrade' to apply any package updates.
### opam upgrade --locked
The following actions will be performed:
  - upgrade tolock l1 to l2 (pinned)

<><> Processing actions <><><><><><><><><><><><><><><><><><><><><><><><><><><><>
-> removed   tolock.l1
-> installed tolock.l2
Done.
### <pin:tolock/tolock.opam>
build: [ "false" ]
version: "3"
### <pin:tolock/tolock.opam.locked>
version: "l3"
### opam update tolock

<><> Synchronising development packages <><><><><><><><><><><><><><><><><><><><>
[tolock.l2] synchronised (file://${BASEDIR}/tolock)
[tolock] Conflicting update of the metadata from file://${BASEDIR}/tolock.
Override files in ${BASEDIR}/OPAM/locking/.opam-switch/overlay/tolock (there will be a backup)? [Y/n] y
User metadata backed up in ${BASEDIR}/OPAM/backup/tolock.bak
Now run 'opam upgrade' to apply any package updates.
### opam upgrade --locked
The following actions will be performed:
  - upgrade tolock l2 to l3 (pinned)

<><> Processing actions <><><><><><><><><><><><><><><><><><><><><><><><><><><><>
-> removed   tolock.l2
-> installed tolock.l3
Done.
### <pin:tolock/tolock.opam>
build: [ "false" ]
version: "4"
### <pin:tolock/tolock.opam.locked>
version: "l4"
### OPAMLOCKED=locked opam update tolock

<><> Synchronising development packages <><><><><><><><><><><><><><><><><><><><>
[tolock.l3] synchronised (file://${BASEDIR}/tolock)
[tolock] Conflicting update of the metadata from file://${BASEDIR}/tolock.
Override files in ${BASEDIR}/OPAM/locking/.opam-switch/overlay/tolock (there will be a backup)? [Y/n] y
User metadata backed up in ${BASEDIR}/OPAM/backup/tolock.bak
Now run 'opam upgrade' to apply any package updates.
### opam upgrade
The following actions will be performed:
  - upgrade tolock l3 to l4 (pinned)

<><> Processing actions <><><><><><><><><><><><><><><><><><><><><><><><><><><><>
-> retrieved tolock.l4  (file://${BASEDIR}/tolock)
-> removed   tolock.l3
-> installed tolock.l4
Done.
